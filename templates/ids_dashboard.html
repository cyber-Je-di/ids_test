<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live IDS Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ids.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet">
    />
  </head>
  <body class="bg-gray-100">

        <nav class="navbar">
        <div class="nav-brand">
            <h1><i class="fa-sharp fa-solid fa-shield-halved"></i> CyberGuardian</h1>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('home') }}" class="nav-link active">Home</a>
            <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
        </div>
    </nav>
    <div class="container mx-auto p-4 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Live IDS Dashboard</h1>
          <p class="text-gray-600">
            Real-time alerts from Snort, classified by the ML model.
          </p>
        </div>
        <div class="flex items-center space-x-2">
          <span
            id="status-indicator"
            class="h-3 w-3 rounded-full bg-yellow-400"
          ></span>
          <span id="status-text" class="text-sm font-medium text-gray-500"
            >Connecting...</span
          >
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-lg">
        <div class="overflow-x-auto">
          <table class="table-auto w-full text-left whitespace-nowrap">
            <thead>
              <tr
                class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b bg-gray-50"
              >
                <th class="px-4 py-3">Timestamp</th>
                <th class="px-4 py-3">Source IP</th>
                <th class="px-4 py-3">Destination IP</th>
                <th class="px-4 py-3">Snort Alert</th>
                <th class="px-4 py-3">ML Prediction</th>
              </tr>
            </thead>
            <tbody id="alerts-table-body" class="divide-y">
              <!-- Rows will be inserted here by JavaScript -->
              <tr id="loading-row">
                <td colspan="5" class="text-center p-8 text-gray-500">
                  Waiting for first alert from processor...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const tableBody = document.getElementById("alerts-table-body");
      const loadingRow = document.getElementById("loading-row");
      const statusIndicator = document.getElementById("status-indicator");
      const statusText = document.getElementById("status-text");
      let lastAlertId = 0; // Keep track of the last seen alert to identify new ones

      async function fetchAlerts() {
        try {
          const response = await fetch("/get_alerts");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const alerts = await response.json();

          // Update status to connected
          statusIndicator.classList.remove("bg-yellow-400", "bg-red-500");
          statusIndicator.classList.add("bg-green-500");
          statusText.textContent = "Connected";

          if (alerts.length === 0 && lastAlertId === 0) {
            // Still waiting for the very first alert
            return;
          }

          // If we have alerts, remove the loading/empty message
          if (loadingRow) {
            loadingRow.remove();
          }

          // Check if there are new alerts to render
          if (alerts.length > 0 && alerts[0].id > lastAlertId) {
            updateTable(alerts);
            lastAlertId = alerts[0].id;
          }
        } catch (error) {
          console.error("Failed to fetch alerts:", error);
          // Update status to show an error
          statusIndicator.classList.remove("bg-yellow-400", "bg-green-500");
          statusIndicator.classList.add("bg-red-500");
          statusText.textContent = "Error";
        }
      }

      function updateTable(alerts) {
        tableBody.innerHTML = ""; // Clear and redraw for simplicity
        alerts.forEach((alert, index) => {
          const row = document.createElement("tr");
          row.className = "text-gray-700 border-b hover:bg-gray-50";

          // Add animation to the very first row if it's new
          if (index === 0) {
            row.classList.add("new-alert");
          }

          // Prediction Badge
          let predictionBadge;
          if (alert.ml_prediction === "Attack") {
            predictionBadge = `<span class="px-2 py-1 font-semibold leading-tight rounded-full text-red-700 bg-red-100">${alert.ml_prediction}</span>`;
          } else if (alert.ml_prediction === "Normal") {
            predictionBadge = `<span class="px-2 py-1 font-semibold leading-tight rounded-full text-green-700 bg-green-100">${alert.ml_prediction}</span>`;
          } else {
            predictionBadge = `<span class="px-2 py-1 font-semibold leading-tight rounded-full text-gray-700 bg-gray-100">${alert.ml_prediction}</span>`;
          }

          // Format timestamp
          const timestamp = new Date(alert.timestamp).toLocaleTimeString();

          row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${timestamp}</td>
                    <td class="px-4 py-3 text-sm font-mono">${alert.source_ip}</td>
                    <td class="px-4 py-3 text-sm font-mono">${alert.dest_ip}</td>
                    <td class="px-4 py-3 text-sm">${alert.attack_type}</td>
                    <td class="px-4 py-3 text-sm">${predictionBadge}</td>
                `;
          tableBody.appendChild(row);
        });
      }

      // --- Initial Load ---
      window.onload = () => {
        fetchAlerts(); // Fetch immediately on load
        setInterval(fetchAlerts, 5000); // Then poll every 5 seconds
      };
    </script>
  </body>
</html>
