<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard - CyberGuard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body>
    <nav class="navbar dashboard-nav">
        <div class="nav-brand">
            <h2><i class="fa-sharp fa-solid fa-shield-halved"></i> CyberGuardian Dashboard</h2>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('home') }}" class="nav-link">Home</a>
            <a href="{{ url_for('dashboard') }}" class="nav-link active">Dashboard</a>
           
              {% if session.get('user_email') %}
    <a href="{{ url_for('logout') }}">Logout</a>
  {% else %}
    <a href="{{ url_for('login') }}">Login</a>
  {% endif %}

{% if session.get('user_role') %}
<span class="user-info">üë§ {{ session['user_role'].capitalize() }}</span>
{% endif %}


        </div>
    </nav>


        <div class="dashboard-grid">
            <div class="dashboard-card" onclick="window.location.href='{{ url_for('ids_dashboard') }}'">
                <div class="card-header">
                    <div class="card-icon">üîç</div>
                    <h3>Real-time Threat Detection</h3>
                </div>
                <div class="card-content">
                    <p>Monitor network traffic for intrusions, brute-force attempts, and malware signatures</p>
                    <div class="card-stats">
                        <div class="stat">
                            <span class="stat-number" id="threatCount">0</span>
                            <span class="stat-label">Active Threats</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="blockedIPs">0</span>
                            <span class="stat-label">Blocked IPs</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="card-action">Access IDS System ‚Üí</span>
                </div>
            </div>

            <div class="dashboard-card" onclick="window.location.href='{{ url_for('phishing_detector') }}'">
                <div class="card-header">
                    <div class="card-icon">üìß</div>
                    <h3>Spam & Scam Email Detection</h3>
                </div>
                <div class="card-content">
                    <p>AI-powered email scanning for phishing indicators and malicious content</p>
                    <div class="card-stats">
                        <div class="stat">
                            <span class="stat-number" id="emailsScanned">0</span>
                            <span class="stat-label">Emails Scanned</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="spamBlocked">0</span>
                            <span class="stat-label">Spam Blocked</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="card-action">Open Email Scanner ‚Üí</span>
                </div>
            </div>

            <div class="dashboard-card" onclick="window.location.href='{{ url_for('sms_detector') }}'">
                <div class="card-header">
                    <div class="card-icon">üì±</div>
                    <h3>Scam SMS Detection</h3>
                </div>
                <div class="card-content">
                    <p>NLP-powered detection of fraudulent SMS messages and malicious links</p>
                    <div class="card-stats">
                        <div class="stat">
                            <span class="stat-number" id="smsAnalyzed">0</span>
                            <span class="stat-label">SMS Analyzed</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="scamsDetected">0</span>
                            <span class="stat-label">Scams Detected</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="card-action">Launch SMS Scanner ‚Üí</span>
                </div>
            </div>

            <div class="dashboard-card" onclick="window.location.href='{{ url_for('awareness_page') }}'">
                <div class="card-header">
                    <div class="card-icon">üéì</div>
                    <h3>Cybersecurity Awareness</h3>
                </div>
                <div class="card-content">
                    <p>Interactive training modules and security awareness simulations</p>
                    <div class="card-stats">
                        <div class="stat">
                            <span class="stat-number" id="trainingModules">12</span>
                            <span class="stat-label">Training Modules</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="usersTrained">0</span>
                            <span class="stat-label">Users Trained</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="card-action">Start Training ‚Üí</span>
                </div>
            </div>

            <div class="dashboard-card large-card" onclick="window.location.href='{{ url_for('threat_dashboard') }}'">
                <div class="card-header">
                    <div class="card-icon">üìä</div>
                    <h3>Threat Analytics Dashboard</h3>
                </div>
                <div class="card-content">
                    <p>Comprehensive visualization of security threats, logs, and real-time analytics</p>
                    <div class="threat-preview">
                        <div class="mini-chart">
                            <canvas id="miniThreatChart" width="200" height="100"></canvas>
                        </div>
                        <div class="threat-summary">
                            <div class="threat-item">
                                <span class="threat-type">üî¥ Critical</span>
                                <span class="threat-count" id="criticalThreats">0</span>
                            </div>
                            <div class="threat-item">
                                <span class="threat-type">üü° Medium</span>
                                <span class="threat-count" id="mediumThreats">0</span>
                            </div>
                            <div class="threat-item">
                                <span class="threat-type">üü¢ Low</span>
                                <span class="threat-count" id="lowThreats">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="card-action">View Full Dashboard ‚Üí</span>
                </div>
            </div>

            <!-- <div class="dashboard-card quick-actions">
                <div class="card-header">
                    <div class="card-icon">‚ö°</div>
                    <h3>Quick Actions</h3>
                </div>
                <div class="card-content">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="runSystemScan()">
                            <span class="btn-icon">üîç</span>
                            System Scan
                        </button>
                        <button class="action-btn" onclick="updateThreatDB()">
                            <span class="btn-icon">üîÑ</span>
                            Update Threat DB
                        </button>
                        <button class="action-btn" onclick="generateReport()">
                            <span class="btn-icon">üìÑ</span>
                            Generate Report
                        </button>
                        <button class="action-btn" onclick="viewLogs()">
                            <span class="btn-icon">üìã</span>
                            View Logs
                        </button>
                    </div>
                </div>
            </div> -->
        </div>

        <!-- <div class="alerts-section">
            <h2>Recent Security Alerts</h2>
            <div class="alerts-container" id="alertsContainer">
                </div>
        </div> -->
    </div>

    <div class="status-item">
    <span>Last Update: <span id="lastUpdate"></span></span>
    </div>

    <!-- =========================
         CHAT MODAL
         ========================= -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-modal-content">
            <div class="chat-header">
                <h3><i class="fa-solid fa-robot"></i> CyberGuard Assistant</h3>
                <span class="close" id="closeChatModal">&times;</span>
            </div>
            <div id="chatMessages" class="chat-messages">
                <!-- Initial welcome message -->
                <div class="chat-assistant">
                    <div class="chat-bubble">
                        <img src="{{ url_for('static', filename='mascot.png') }}" alt="Mascot" class="chat-avatar">
                        <p>Welcome! I'm your CyberGuard Assistant. Ask me about cybersecurity tips, how to spot phishing, or how to protect your accounts.</p>
                    </div>
                </div>
            </div>
            <form id="chatForm" class="chat-form">
                <input type="text" id="chatInput" placeholder="Type your message..." required autocomplete="off" />
                <button type="submit" aria-label="Send message">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- FLOATING BUTTON TO OPEN CHAT -->
    <button id="openChatBtn" class="chat-open-btn" aria-label="Open chat">
        <i class="fa-solid fa-comment-dots fa-xl"></i>
    </button>

    <!-- SCRIPT -->
    <script>
        // Chat Modal Logic
        const chatModal = document.getElementById('chatModal');
        const openChatBtn = document.getElementById('openChatBtn');
        const closeChatModal = document.getElementById('closeChatModal');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');

        openChatBtn.onclick = () => { chatModal.style.display = 'block'; };
        closeChatModal.onclick = () => { chatModal.style.display = 'none'; };
        window.onclick = (event) => { if (event.target == chatModal) chatModal.style.display = 'none'; };

        chatForm.onsubmit = async function(e) {
            e.preventDefault();
            const userMsg = chatInput.value.trim();
            if (!userMsg) return;
            appendMessage('user', userMsg);
            chatInput.value = '';

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMsg })
                });
                const data = await res.json();
                appendMessage('assistant', data.reply);
            } catch (err) {
                appendMessage('assistant', 'Sorry, there was an error connecting to the assistant.');
            }
        };

        function appendMessage(role, text) {
            const msgContainer = document.createElement('div');
            msgContainer.className = role === 'user' ? 'chat-user' : 'chat-assistant';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = text;

            if (role === 'assistant') {
                const avatar = document.createElement('img');
                // Note: The url_for needs to be handled carefully in JS.
                // A better approach would be to pass this from the template to JS.
                // For now, we hardcode the path as the script is inline.
                avatar.src = "{{ url_for('static', filename='mascot.png') }}";
                avatar.alt = "Mascot";
                avatar.className = 'chat-avatar';
                msgContainer.appendChild(avatar);
            }

            msgContainer.appendChild(bubble);

            // Clear the initial welcome message if it exists
            const initialWelcome = document.querySelector('#chatMessages .chat-assistant');
            if (initialWelcome && chatMessages.children.length === 1) {
                chatMessages.innerHTML = '';
            }

            chatMessages.appendChild(msgContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>